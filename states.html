<!DOCTYPE html>
<html lang="en">
<head>
    <script src="./js/jquery.min.js"></script>
    <meta charset="UTF-8">
    <title>Title</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover">
        <title>Used Cars for Sale in the US - Carslyst</title>
        <link rel="stylesheet" href="./css/style.css">
        <script src="./js/utlParam.js"></script>
</head>
<body>
<header id="header">
</header>

<main style="height: auto !important;">
    <div class="main" style="height: auto !important;">
        <div class="container detail">
            <h1>Used Cars Near Me</h1>

        </div>
        <div class="bottom" style="height: auto !important;">
            <div class="container" style="height: auto !important;">
                <div class="general-wrap">
                    <h2>Browse by State</h2>
                    <ul class="general-list state-list">

                    </ul>
                </div>

                <div class="general-wrap">
                    <h2>Browse by Make</h2>
                    <ul class="general-list brand-list">
                        <li class="general-item">
                            <a href="/car-makes/toyota/" class="link-cover"></a>
                            <div class="brand-pic"><img lazyload="" src="https://pub-683228af40b042bb882e1ed4bda118b8.r2.dev/images/toyota.png"  alt="Toyota"></div>
                            <a href="/car-makes/toyota/" class="brand-name">Toyota</a>

                        </li>
                        <li class="general-item">
                            <a href="/car-makes/honda/" class="link-cover"></a>
                            <div class="brand-pic"><img lazyload="" src="https://pub-683228af40b042bb882e1ed4bda118b8.r2.dev/images/honda.png"  alt="Honda"></div>
                            <a href="/car-makes/honda/" class="brand-name">Honda</a>

                        </li>
                        <li class="general-item">
                            <a href="/car-makes/nissan/" class="link-cover"></a>
                            <div class="brand-pic"><img lazyload="" src="https://pub-683228af40b042bb882e1ed4bda118b8.r2.dev/images/nissan.png"  alt="Nissan"></div>
                            <a href="/car-makes/nissan/" class="brand-name">Nissan</a>

                        </li>
                        <li class="general-item">
                            <a href="/car-makes/hyundai/" class="link-cover"></a>
                            <div class="brand-pic"><img lazyload="" src="https://pub-683228af40b042bb882e1ed4bda118b8.r2.dev/images/hyundai.png"  alt="Hyundai"></div>
                            <a href="/car-makes/hyundai/" class="brand-name">Hyundai</a>

                        </li>
                        <li class="general-item">
                            <a href="/car-makes/ford/" class="link-cover"></a>
                            <div class="brand-pic"><img lazyload="" src="https://pub-683228af40b042bb882e1ed4bda118b8.r2.dev/images/ford.png"  alt="Ford"></div>
                            <a href="/car-makes/ford/" class="brand-name">Ford</a>

                        </li>
                        <li class="general-item">
                            <a href="/car-makes/chevrolet/" class="link-cover"></a>
                            <div class="brand-pic"><img lazyload="" src="https://pub-683228af40b042bb882e1ed4bda118b8.r2.dev/images/chevrolet.png"  alt="Chevrolet"></div>
                            <a href="/car-makes/chevrolet/" class="brand-name">Chevrolet</a>

                        </li>
                        <li class="general-item">
                            <a href="/car-makes/jeep/" class="link-cover"></a>
                            <div class="brand-pic"><img lazyload="" src="https://pub-683228af40b042bb882e1ed4bda118b8.r2.dev/images/jeep.png"  alt="Jeep"></div>
                            <a href="/car-makes/jeep/" class="brand-name">Jeep</a>

                        </li>
                        <li class="general-item">
                            <a href="/car-makes/bmw/" class="link-cover"></a>
                            <div class="brand-pic"><img lazyload="" src="https://pub-683228af40b042bb882e1ed4bda118b8.r2.dev/images/bmw.png"  alt="BMW"></div>
                            <a href="/car-makes/bmw/" class="brand-name">BMW</a>

                        </li>
                        <li class="general-item">
                            <a href="/car-makes/mercedes-benz/" class="link-cover"></a>
                            <div class="brand-pic"><img lazyload="" src="https://pub-683228af40b042bb882e1ed4bda118b8.r2.dev/images/mercedes-benz.png"  alt="Mercedes-Benz"></div>
                            <a href="/car-makes/mercedes-benz/" class="brand-name">Mercedes-Benz</a>

                        </li>
                        <li class="general-item">
                            <a href="/car-makes/kia/" class="link-cover"></a>
                            <div class="brand-pic"><img lazyload="" src="https://pub-683228af40b042bb882e1ed4bda118b8.r2.dev/images/kia.png"  alt="Kia"></div>
                            <a href="/car-makes/kia/" class="brand-name">Kia</a>

                        </li>
                    </ul>
                </div>

            </div>
            <div class="aside">
                <div class="aside-type">
                    <h2>Browse by Type</h2>
                    <ul class="aside-type-list number">
                        <li class="aside-type-item">
                            <a href="/used-cars/suvs/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-suvs"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/suvs/" class="aside-type-name">SUVs for Sale</a>
                                <span class="aside-type-count general-num">57,716</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/trucks/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-trucks"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/trucks/" class="aside-type-name">Trucks for Sale</a>
                                <span class="aside-type-count general-num">32,949</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/sedans/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-sedans"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/sedans/" class="aside-type-name">Sedans for Sale</a>
                                <span class="aside-type-count general-num">46,390</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/hybrids/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-hybrids"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/hybrids/" class="aside-type-name">Hybrids for Sale</a>
                                <span class="aside-type-count general-num">21,852</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/vans/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-vans"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/vans/" class="aside-type-name">Vans for Sale</a>
                                <span class="aside-type-count general-num">16,612</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/coupes/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-coupes"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/coupes/" class="aside-type-name">Coupes for Sale</a>
                                <span class="aside-type-count general-num">19,882</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/hatchbacks/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-hatchbacks"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/hatchbacks/" class="aside-type-name">Hatchbacks for Sale</a>
                                <span class="aside-type-count general-num">21,132</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/convertibles/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-convertibles"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/convertibles/" class="aside-type-name">Convertibles for Sale</a>
                                <span class="aside-type-count general-num">11,636</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/motorcycles/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-motorcycles"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/motorcycles/" class="aside-type-name">Motorcycles for Sale</a>
                                <span class="aside-type-count general-num">3,664</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/classic-cars/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-classic-cars"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/classic-cars/" class="aside-type-name">Classic Cars for Sale</a>
                                <span class="aside-type-count general-num">17,249</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/rvs-and-campers/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-rvs-and-campers"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/rvs-and-campers/" class="aside-type-name">RVs &amp; Campers for Sale</a>
                                <span class="aside-type-count general-num">15,149</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/motorhomes/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-motorhomes"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/motorhomes/" class="aside-type-name">Motorhomes for Sale</a>
                                <span class="aside-type-count general-num">19,502</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/station-wagons/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-station-wagons"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/station-wagons/" class="aside-type-name">Station Wagons for Sale</a>
                                <span class="aside-type-count general-num">13,354</span>
                            </span>
                        </li>
                        <li class="aside-type-item">
                            <a href="/used-cars/trailers/" class="link-cover"></a>
                            <svg class="aside-type-icon">
                                <use xlink:href="#icon-trailers"></use>
                            </svg>
                            <span>
                                <a href="/used-cars/trailers/" class="aside-type-name">Trailers for Sale</a>
                                <span class="aside-type-count general-num">16,647</span>
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</main>

<footer  id="footer">
</footer>
<script>
    // 加载 header
    fetch('./header.html')
        .then(res => res.text())
        .then(data => {
            document.getElementById('header').innerHTML = data;

            $(".icon-nav").click(function() {
                $(".nav-cover").toggleClass('expand');
                $(".header-nav").toggleClass('expand');
            })
            $(".nav-cover").click(function() {
                $(".nav-cover").toggleClass('expand');
                $(".header-nav").toggleClass('expand');
            })

            $(".nav-item.expand .nav-con").on('click', function(e) {
                if ($(e.target).closest('.icon-go').length) {
                    e.preventDefault();
                    $(this).parent().find(".nav-sub-list").toggleClass("expand");
                }
            });
        });

    // 加载 footer
    fetch('./footer.html')
        .then(res => res.text())
        .then(data => {
            document.getElementById('footer').innerHTML = data;
        });
</script>

<script type="module">
    import {
        fetchAllCategoriesWithCount,
        fetchAllStates
    } from './js/supabaseApi.js';

    /* =========================
       CATEGORY META
    ========================= */
    const CATEGORY_META = {
        SUVs: { slug: "suvs", icon: "icon-suvs" },
        Trucks: { slug: "trucks", icon: "icon-trucks" },
        Sedans: { slug: "sedans", icon: "icon-sedans" },
        Hybrids: { slug: "hybrids", icon: "icon-hybrids" },
        Vans: { slug: "vans", icon: "icon-vans" },
        Coupes: { slug: "coupes", icon: "icon-coupes" },
        Hatchbacks: { slug: "hatchbacks", icon: "icon-hatchbacks" },
        Convertibles: { slug: "convertibles", icon: "icon-convertibles" },
        Motorcycles: { slug: "motorcycles", icon: "icon-motorcycles" },
        "Classic Cars": { slug: "classic-cars", icon: "icon-classic-cars" },
        "RVs & Campers": { slug: "rvs-and-campers", icon: "icon-rvs-and-campers" },
        Motorhomes: { slug: "motorhomes", icon: "icon-motorhomes" },
        "Station Wagons": { slug: "station-wagons", icon: "icon-station-wagons" },
        Trailers: { slug: "trailers", icon: "icon-trailers" }
    };

    /* =========================
       STATE ABBR
    ========================= */
    const STATE_ABBR = {
        Alabama: "al",
        Alaska: "ak",
        Arizona: "az",
        Arkansas: "ar",
        California: "ca",
        Colorado: "co",
        Connecticut: "ct",
        Delaware: "de",
        "District of Columbia": "dc",
        Florida: "fl",
        Georgia: "ga",
        Hawaii: "hi",
        Idaho: "id",
        Illinois: "il",
        Indiana: "in",
        Iowa: "ia",
        Kansas: "ks",
        Kentucky: "ky",
        Louisiana: "la",
        Maine: "me",
        Maryland: "md",
        Massachusetts: "ma",
        Michigan: "mi",
        Minnesota: "mn",
        Mississippi: "ms",
        Missouri: "mo",
        Montana: "mt",
        Nebraska: "ne",
        Nevada: "nv",
        "New Hampshire": "nh",
        "New Jersey": "nj",
        "New Mexico": "nm",
        "New York": "ny",
        "North Carolina": "nc",
        "North Dakota": "nd",
        Ohio: "oh",
        Oklahoma: "ok",
        Oregon: "or",
        Pennsylvania: "pa",
        "Rhode Island": "ri",
        "South Carolina": "sc",
        "South Dakota": "sd",
        Tennessee: "tn",
        Texas: "tx",
        Utah: "ut",
        Vermont: "vt",
        Virginia: "va",
        Washington: "wa",
        "West Virginia": "wv",
        Wisconsin: "wi",
        Wyoming: "wy"
    };

    /* =========================
       HELPERS
    ========================= */
    function formatNumber(num) {
        return Number(num).toLocaleString("en-US");
    }

    /* =========================
       RENDER CATEGORY TYPES
    ========================= */
    async function renderCategoryTypes() {
        const { data: categories, error } = await fetchAllCategoriesWithCount();

        if (error) {
            console.error("Category fetch error:", error);
            return;
        }

        const ul = document.querySelector(".aside-type-list.number");
        if (!ul) return;

        ul.innerHTML = "";

        const params = new URLSearchParams(window.location.search);

        const make = params.get("make");
        const state = params.get("state");
        const category = params.get("category");



        categories.forEach(({ category, count }) => {

            const meta = CATEGORY_META[category];
            if (!meta) return;

            const li = document.createElement("li");
            li.className = "aside-type-item";

            let next_url = ``

            if(!make && !state){
                next_url = `./states.html?category=${category}`
            }

            li.innerHTML = `
            <a href="${next_url}" class="link-cover"></a>

            <svg class="aside-type-icon">
                <use xlink:href="#${meta.icon}"></use>
            </svg>

            <span>
                <a href="/used-cars/${meta.slug}/"
                   class="aside-type-name">
                   ${category} for Sale
                </a>

                <span class="aside-type-count general-num">
                    ${formatNumber(count)}
                </span>
            </span>
        `;

            ul.appendChild(li);
        });
    }

    /* =========================
       RENDER STATE LIST
    ========================= */
    async function renderStateList() {

        const { data: states, error } = await fetchAllStates();

        if (error) {
            console.error("State fetch error:", error);
            return;
        }

        const ul = document.querySelector(".general-list.state-list");
        if (!ul) return;

        ul.innerHTML = "";

        const params = new URLSearchParams(window.location.search);

        const make = params.get("make");
        const state = params.get("state");
        const category = params.get("category");

        states.forEach(({ state }) => {

            const abbr = STATE_ABBR[state];
            if (!abbr) return;

            const li = document.createElement("li");
            li.className = "general-item";

            let next_url = ``
            if(!make && category){
                next_url = `./list.html?category=${category}&state=${state}`
            }

            if(make && !category){
                next_url = `./list.html?make=${make}&state=${state}`
            }

            if(!make && !category){
                next_url = `./types.html?state=${state}`
            }

            li.innerHTML = `
            <a href="${next_url}"
               class="general-link">

               <span class="general-name">
                   ${state}
               </span>

            </a>
        `;

            ul.appendChild(li);
        });
    }

    /* =========================
       INIT
    ========================= */
    document.addEventListener("DOMContentLoaded", () => {

        renderCategoryTypes();
        renderStateList();

    });
</script>


</body>
</html>